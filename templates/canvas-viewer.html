<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
body{
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}


.main {
  height: 100%;
  display: flex;
}
.left {
  float: left;
  width: 220px;
}
.right {
  flex-grow: 1;
  background-color: silver;
}




.
    </style>

    <script>

'use strict';

var ps = [];
var displays = [];
var drawDisplay = false;
var viewer;

class Display {
  constructor(ps) {
    this.points = ps;
    this.selected = false;
    this.port = "5556";
    this.aspect = "16:9";
    this.width = "720";
  }

    draw() {
        var stroke = "rgba(255, 255, 255, 0.7)";
        var fill = "rgba(0, 0, 255, 0.3)";
        if (this.selected) {
            stroke = "rgba(255, 255, 0, 1)";
            viewer.context.lineWidth = 3;
        }
        else {
            viewer.context.lineWidth = 1;
        }
        viewer.drawPolygon(this.points, fill);
        viewer.drawPolyline(this.points, stroke, false);
    }

    select(x, y) {
        if (this.isInside(this.points[0].x, this.points[0].y,
                this.points[1].x, this.points[1].y,
                this.points[2].x, this.points[2].y,
                x, y) ||
            this.isInside(this.points[2].x, this.points[2].y,
                this.points[3].x, this.points[3].y,
                this.points[0].x, this.points[0].y,
                x, y)) {
            this.selected = true;

            var form = document.getElementById('fields');
            var port = document.getElementById("port");
            var aspect = document.getElementById("aspect");
            var width = document.getElementById("width");
            port.value = this.port;
            aspect.value = this.aspect;
            width.value = this.width;

            form.hidden = false;
        }
        else {
            this.selected = false;
        }
    }

    area(x1, y1, x2, y2, x3, y3) {
        return Math.abs((x1*(y2-y3) + x2*(y3-y1)+ x3*(y1-y2))/2.0);
    };

    isInside(x1, y1, x2, y2, x3, y3, x, y) {
       var A = this.area(x1, y1, x2, y2, x3, y3);
       var A1 = this.area(x, y, x2, y2, x3, y3);
       var A2 = this.area(x1, y1, x, y, x3, y3);
       var A3 = this.area(x1, y1, x2, y2, x, y);
       return (Math.round(A) == Math.round(A1 + A2 + A3));
    }

};


class CanvasView {


  constructor(canvas, source) {
    this.canvas = canvas;
    this.context = canvas.getContext("2d");
    //this.image = new Image();
    //this.image.src = source.toDataURL("image/png");
    this.image = source;
    this.canvas.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); return false;}
    this.isMove = false;
    this.x1 = 0;
    this.y1 = 0;
    this.w1 = this.image.width;
    this.h1 = this.image.height;
    this.mouseX = 0;
    this.mouseY = 0;

    this.canvas.addEventListener('mouseover', this.mouseuplistener.bind(this));
    this.canvas.addEventListener('mousedown', this.mousedownlistener.bind(this));
    this.canvas.addEventListener('mousemove', this.mousemovelistener.bind(this));
    this.canvas.addEventListener('mouseup', this.mouseuplistener.bind(this));
    this.canvas.addEventListener('wheel', this.wheellistener.bind(this), { passive: true });


    this.x1 = -(this.image.width - this.canvas.width) / 2;
    this.y1 = -(this.image.height - this.canvas.height) / 2;

    this.draw();
  } 

  mousedownlistener(event) {
    this.mouse(event);

    this.oldx = this.mouseX;
    this.oldy = this.mouseY;

    if (event.button == 0) {
      this.isMove = true;
      var x = (this.mouseX - this.x1) / this.scale;
      var y = (this.mouseY - this.y1) / this.scale;

      // selection
      var form = document.getElementById('fields');
      form.hidden = true;

      for (var display of displays) {
        display.select(x, y);
      }

      viewer.draw();
    }
    if (event.button == 2) {
      this.scale = this.w1 / this.image.width;
      var x = (this.mouseX - this.x1) / this.scale;
      var y = (this.mouseY - this.y1) / this.scale;

      if (drawDisplay) {
          ps.push({"x": x, "y": y});

          if (ps.length == 4) {
            var btn = document.getElementById("create-display");
            btn.click();
            displays.push(new Display(ps));
            ps = [];
          }

          viewer.draw();
      }
    }
  }

  mousemovelistener(event) {
    this.mouse(event);

    if (this.isMove) {
      let dx = this.mouseX - this.oldx;
      this.x1 += dx;

      let dy = this.mouseY - this.oldy;
      this.y1 += dy;

      this.draw();

      this.oldx = this.mouseX;
      this.oldy = this.mouseY;
    }

    if (drawDisplay) {
      this.draw();
    }
  }

  mouseuplistener(event) {
    this.mouse(event);

    this.isMove = false;
  }

  wheellistener(e) {
    this.mouse(e);

    if (! this.isMove) {
      var delta = e.deltaY || e.detail || e.wheelDelta;

      if (delta < 0) {
        this.x1 = this.mouseX - (this.mouseX - this.x1) * 1.2;
        this.y1 = this.mouseY - (this.mouseY - this.y1) * 1.2;
        this.w1 *= 1.2;
        this.h1 *= 1.2;

        this.draw();
      }
      else {
	
        this.x1 = this.mouseX - (this.mouseX - this.x1) / 1.2;
        this.y1 = this.mouseY - (this.mouseY - this.y1) / 1.2;
        this.w1 /= 1.2;
        this.h1 /= 1.2;

        this.draw();
      }
    }
  }

  mouse(e) {
    var boundings = this.canvas.getBoundingClientRect();
    this.mouseX = e.clientX - boundings.left;
    this.mouseY = e.clientY - boundings.top;
  }

  drawPolygon(psp, style) {
    this.context.fillStyle = style;
    this.context.beginPath();
    var first = true;

    // draw temporally polygon
    for (var p of psp) {
      // screen x y
      var x = this.x1 + p.x * this.scale;
      var y = this.y1 + p.y * this.scale;

      if (first) {
         this.context.moveTo(x, y);
      }
      else {
         this.context.lineTo(x, y);
      }
      first = false;
    }
    this.context.closePath();
    this.context.fill();
  }

  drawPolyline(psp, style, opened=true) {
    this.context.strokeStyle = style;
    this.context.beginPath();
    var first = true;
    var oldx, oldy;
    var firstx, firsty;

    // draw temporally line
    for (var p of psp) {
      // screen x y
      var x = this.x1 + p.x * this.scale;
      var y = this.y1 + p.y * this.scale;

      if (! first) {
        this.context.beginPath();
        this.context.moveTo(oldx, oldy);
        this.context.lineTo(x, y);
        this.context.closePath();
        this.context.stroke();
      }
      else {
        firstx = x;
        firsty = y;
      }
      first = false;
      oldx = x;
      oldy = y;
    }
    if (! first && ! opened) {
        this.context.beginPath();
        this.context.moveTo(oldx, oldy);
        this.context.lineTo(firstx, firsty);
        this.context.closePath();
        this.context.stroke();
    }
  }

  draw() {
    this.scale = this.w1 / this.image.width;
    var canvas = document.getElementById("paint-canvas");
    var right = document.getElementById("right");
    canvas.width = right.clientWidth;
    canvas.height = right.clientHeight;
    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    this.context.drawImage(this.image, this.x1, this.y1, this.w1, this.h1);

    this.drawPolyline(ps, "rgba(255, 255, 255, 0.7)");

    if (ps.length > 0 && drawDisplay) {
      var x = this.x1 + ps[ps.length - 1].x * this.scale;
      var y = this.y1 + ps[ps.length - 1].y * this.scale;
      this.context.beginPath();
      this.context.moveTo(x, y);
      this.context.lineTo(this.mouseX, this.mouseY);
      this.context.closePath();
      this.context.stroke();
    }

    this.drawPolygon(ps, "rgba(0, 0, 255, 0.3)");

    // draw temporally points
    this.context.fillStyle = "rgba(255, 0, 0, 0.5)";
    this.context.strokeStyle = "rgba(255, 255, 255)";

    for (var p of ps) {

      // screen x y
      var x = this.x1 + p.x * this.scale;
      var y = this.y1 + p.y * this.scale;
      this.context.fillRect(x - 5, y - 5, 11, 11);
      this.context.strokeRect(x, y, 1, 1);
    }

    for (var display of displays) {
        display.draw();
    }
  }
};




window.addEventListener('resize', function(event) {
  viewer.draw();
}, true);




window.onload = function () {
  // Definitions
  var image = document.getElementById('source');
  var canvas = document.getElementById("paint-canvas");
  var right = document.getElementById("right");
  canvas.width = right.clientWidth;
  canvas.height = right.clientHeight;
  viewer = new CanvasView(canvas, image);

  var btn = document.getElementById("create-display");
  btn.onclick=function(e) {
    if (window.getComputedStyle(this).borderStyle != 'inset') {
      this.style.backgroundColor = 'red';
      this.style.borderStyle = 'inset';
      drawDisplay = true;
      ps = [];
      viewer.draw();
    }
    else {
      this.style.backgroundColor = 'white';
      this.style.borderStyle = 'outset';
      drawDisplay = false;
      viewer.draw();
    }
  }


  function loadContent(project) {
    var param = {"project": {{project}}};

    $.ajax({
      type: "POST",
      url: "/content",
      data: JSON.stringify(param),
      contentType: "application/json",
      success: function(result) {
        console.log("Result:");
        console.log(result);

        var div = document.getElementById('content');
        div.innerHTML = result;
        div = document.getElementById('welcome');
        div.innerHTML = '<div class="glitch" data-text="Welcome to ' + project + ' project">Welcome to ' + project + ' project</div>';
      }
    });
  }




  var btnSave = document.getElementById("save");
  btnSave.onclick=function(e) {
    var json = JSON.stringify(displays);
    $.ajax({
      type: "POST",
      url: "/points",
      data: json,
      contentType: "application/json",
      success: function(result) {
        location.href = "/?project={{project}}";
      }
    });
  }

{%for p in points%}
    ps = []
    {% for point in p.points %}
       ps.push({"x": {{point.x}}, "y": {{point.y}}});
    {%endfor%}
    displays.push(new Display(ps));
    displays[displays.length - 1].port = {{p.port}};
    displays[displays.length - 1].aspect = '{{p.aspect}}';
    displays[displays.length - 1].width = {{p.width}};
    console.log(displays.length);
/*
    this.port = "5556";
    this.aspect = "16:9";
    this.width = "720";
*/

{%endfor%}
    ps = [];
    viewer.draw();
};



function fillForm() {
  var port = document.getElementById("port");
  var aspect = document.getElementById("aspect");
  var width = document.getElementById("width");

  for (var d of displays) {

    if (d.selected) {
        d.port = port.value;
        d.aspect = aspect.value;
        d.width = width.value;
    }
  }
}


    </script>

  </head>


  <body>



<div class="main">
         <div class="left">Menu<br />
            <input id="create-display" type="button" value="+" style="border-style: outset;" />
            <br />
            <br />
            Monitor corner selection order:
            <br />
            <img src="/static/images/corners.png" />
            <br />
            <br />Controls:
            <li> Scroll - left mouse
            <li> Set point - right mouse
            <li> Zoom - mouse wheel
            <br />
            <br />



            <form id="fields" hidden onchange="fillForm()">
               port: <br /><input id="port" type="text" name="port" value="5556" oninput="fillForm()"><br />
               aspect: <br /><select name="aspect" id="aspect">
                 <option selected>16:9</option>
                 <option>4:3</option>
               </select><br />
               render width: <br /><input type="text" name="width" id="width" value="720" oninput="fillForm()"><br />
            </form>

            <br />
            <br />
            <input id="save" type="button" value="Save" style="border-style: inset;" />
         </div>

         <div class="right" id="right">
            <canvas id=paint-canvas class="right"></canvas>
            <img id=source src={{path}} hidden />
         </div>
</div>

  </body>

</html>